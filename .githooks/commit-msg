#!/usr/bin/env bash
# .githooks/commit-msg
# Validates commit message format and disallows forbidden markers

set -euo pipefail

MSG_FILE="$1"
HEADLINE=$(head -n1 "$MSG_FILE" | tr -d '\r')

# Allowed types
TYPE_PATTERN='^(feat|fix|refactor|docs|test|chore|feat\(atlas\)|docs\(log\)|docs\(plan\)):\s'

if ! echo "$HEADLINE" | grep -Eq "$TYPE_PATTERN"; then
  echo "‚ùå Invalid commit message. Use: <type>: <description>"
  echo "   Allowed types: feat | fix | refactor | docs | test | chore | feat(atlas) | docs(log) | docs(plan)"
  echo "   Detected: '$HEADLINE'"
  exit 1
fi

# Disallow AI/co-author markers
if grep -qiE 'Co-Authored-By:|Claude|AI generated|ü§ñ' "$MSG_FILE"; then
  echo "‚ùå Co-author or AI markers detected: forbidden by rules"
  exit 1
fi

exit 0
